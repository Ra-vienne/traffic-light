<!DOCTYPE html>
<html>
  <head>
    <title>Traffic Light Controller</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }
      .light-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      .light {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 15px;
        padding: 15px;
        border-radius: 8px;
        background-color: #f0f0f0;
        width: 180px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .light-name {
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 1.2em;
      }
      .light-indicator {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 8px 0;
        border: 3px solid #333;
        background-color: #444;
        transition: background-color 0.3s;
      }
      .light-status {
        margin-top: 10px;
        font-size: 0.9em;
      }
      .command-box {
        margin: 30px 0;
        padding: 20px;
        background-color: #f8f8f8;
        border-radius: 8px;
      }
      textarea {
        width: 100%;
        height: 100px;
        margin: 10px 0;
        padding: 10px;
        font-family: monospace;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        padding: 10px 20px;
        margin-right: 10px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
      }
      button:hover {
        background-color: #45a049;
      }
      .status {
        margin: 20px 0;
        padding: 15px;
        background-color: #e8f4f8;
        border-radius: 8px;
      }
      .serial-output {
        font-family: monospace;
        white-space: pre;
        background-color: #f5f5f5;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 20px;
      }
      .command-list {
        margin-top: 15px;
      }
      .command-list li {
        margin-bottom: 5px;
        font-family: monospace;
      }
      .active-red {
        background-color: #ff4444;
        box-shadow: 0 0 15px #ff4444;
      }
      .active-yellow {
        background-color: #ffcc00;
        box-shadow: 0 0 15px #ffcc00;
      }
      .active-green {
        background-color: #00cc66;
        box-shadow: 0 0 15px #00cc66;
      }
      .system-status {
        padding: 10px;
        border-radius: 4px;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
    </style>
    <script>
      // Current state tracking
      let currentState = {
        NORTH: { red: "0", yellow: "0", green: "0" },
        SW: { red: "0", yellow: "0", green: "0" },
        SE: { red: "0", yellow: "0", green: "0" },
        NW: { red: "0", yellow: "0", green: "0" },
        NE: { red: "0", yellow: "0", green: "0" },
      };

      // Update light indicators based on current state
      function updateLightIndicators() {
        for (const [light, states] of Object.entries(currentState)) {
          const lightElement = document.getElementById(light.toLowerCase());
          if (lightElement) {
            // Update indicator lights
            lightElement.querySelector(".red-indicator").className =
              states.red === "1"
                ? "red-indicator light-indicator active-red"
                : "red-indicator light-indicator";
            lightElement.querySelector(".yellow-indicator").className =
              states.yellow === "1"
                ? "yellow-indicator light-indicator active-yellow"
                : "yellow-indicator light-indicator";
            lightElement.querySelector(".green-indicator").className =
              states.green === "1"
                ? "green-indicator light-indicator active-green"
                : "green-indicator light-indicator";

            // Update status text
            let statusText = "";
            if (states.red === "1") statusText = "RED";
            if (states.yellow === "1") statusText = "YELLOW";
            if (states.green === "1") statusText = "GREEN";
            lightElement.querySelector(".light-status").textContent =
              statusText || "OFF";
          }
        }
      }

      // Fetch latest state from server
      function fetchState() {
    fetch("/get_state")
        .then((response) => response.json())
        .then((data) => {
            // Update current state with new data
            for (const light of ["NORTH", "SW", "SE", "NW", "NE"]) {
                if (data[light]) {
                    currentState[light] = {
                        red: String(data[light].red),
                        yellow: String(data[light].yellow),
                        green: String(data[light].green)
                    };
                }
            }
            updateLightIndicators();
        })
        .catch((error) => console.error("Error fetching state:", error));
}

      // Fetch serial output from server
      function fetchSerialOutput() {
        fetch("/get_serial_output")
          .then((response) => response.text())
          .then((data) => {
            document.getElementById("serial-output").textContent = data;
            document.getElementById("serial-output").scrollTop =
              document.getElementById("serial-output").scrollHeight;
          })
          .catch((error) =>
            console.error("Error fetching serial output:", error)
          );
      }

      // Send command to Arduino
      function sendCommand() {
        const command = document.getElementById("command").value.trim();
        if (command) {
          fetch("/send_command", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "command=" + encodeURIComponent(command),
          })
            .then((response) => response.text())
            .then((data) => {
              document.getElementById("command").value = "";
              fetchSerialOutput();
            })
            .catch((error) => console.error("Error sending command:", error));
        }
      }

      // Quick command buttons
      function quickCommand(cmd) {
        document.getElementById("command").value = cmd;
        sendCommand();
      }

      // Update everything periodically
      function updateAll() {
        fetchState();
        fetchSerialOutput();
      }

      // Initialize and set up periodic updates
      document.addEventListener("DOMContentLoaded", function () {
        updateAll();
        setInterval(updateAll, 1000); // Update every second

        // Set up button event listeners
        document
          .getElementById("send-button")
          .addEventListener("click", sendCommand);
        document
          .getElementById("status-button")
          .addEventListener("click", () => quickCommand("!status"));
        document
          .getElementById("pause-button")
          .addEventListener("click", () => quickCommand("!pause"));
        document
          .getElementById("resume-button")
          .addEventListener("click", () => quickCommand("!resume"));
      });
    </script>
  </head>
  <body>
    <div class="container">
      <h1>Traffic Light Controller</h1>

      <div class="status">
        <div
          class="system-status {{ 'connected' if serial_connected else 'disconnected' }}"
        >
          Serial Connection: {{ 'Connected' if serial_connected else
          'Disconnected' }} | Port: {{ port }}
        </div>
        <p>Current Mode: {{ 'PAUSED' if is_paused else 'RUNNING' }}</p>
      </div>

      <h2>Traffic Lights</h2>
      <div class="light-container">
        {% for light in ['NORTH', 'SW', 'SE', 'NW', 'NE'] %}
        <div class="light" id="{{ light.lower() }}">
          <div class="light-name">{{ light }}</div>
          <div class="red-indicator light-indicator"></div>
          <div class="yellow-indicator light-indicator"></div>
          <div class="green-indicator light-indicator"></div>
          <div class="light-status">OFF</div>
        </div>
        {% endfor %}
      </div>

      <div class="command-box">
        <h3>Send Command</h3>
        <textarea
          id="command"
          placeholder="Enter command (e.g., !status, !pause, !resume, !order 0,1,2,3,4)"
        ></textarea>
        <div>
          <button id="send-button">Send</button>
          <button id="status-button">Status</button>
          <button id="pause-button">Pause</button>
          <button id="resume-button">Resume</button>
        </div>
        <div class="command-list">
          <h4>Available Commands:</h4>
          <ul>
            {% for cmd in commands %}
            <li>{{ cmd }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <h3>Serial Output</h3>
      <div class="serial-output" id="serial-output">{{ serial_output }}</div>
    </div>
  </body>
</html>
